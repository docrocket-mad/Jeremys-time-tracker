<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeremy's Time Tracker</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Debug: Check what lucide contains
        console.log('Lucide object:', lucide);

        // Listen for IPC messages from main process (for Electron tray integration)
        if (typeof require !== 'undefined') {
            const { ipcRenderer } = require('electron');

            // Function to toggle timer from tray
            window.toggleTimerFromTray = () => {
                // This will be set up after the component mounts
                if (window.currentTimerToggle) {
                    window.currentTimerToggle();
                }
            };

            // Listen for toggle-timer message from tray
            ipcRenderer.on('toggle-timer', () => {
                window.toggleTimerFromTray();
            });
        }

        // Simple fallback - use text if icons don't work
        const Play = () => React.createElement('span', null, '▶');
        const Pause = () => React.createElement('span', null, '⏸');
        const Square = () => React.createElement('span', null, '⏹');
        const Download = () => React.createElement('span', null, '⬇');
        const Clock = () => React.createElement('span', null, '🕐');
        const Calendar = () => React.createElement('span', null, '📅');
        const BarChart3 = () => React.createElement('span', null, '📊');
        const Plus = () => React.createElement('span', null, '+');
        const Edit2 = () => React.createElement('span', null, '✏');
        const Trash2 = () => React.createElement('span', null, '🗑');
        const Settings = () => React.createElement('span', null, '⚙');

        const TimeTracker = () => {
            const [projectCodes, setProjectCodes] = useState([]);
            const [timeEntries, setTimeEntries] = useState([]);
            const [selectedProject, setSelectedProject] = useState('');
            const [isTracking, setIsTracking] = useState(false);
            const [currentSession, setCurrentSession] = useState(null);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [showSetup, setShowSetup] = useState(false);
            const [newProjectCode, setNewProjectCode] = useState('');
            const [newProjectDescription, setNewProjectDescription] = useState('');
            const [storageError, setStorageError] = useState(null);
            const intervalRef = useRef(null);

            // Load data from localStorage on component mount
            useEffect(() => {
                try {
                    const savedCodes = localStorage.getItem('projectCodes');
                    const savedEntries = localStorage.getItem('timeEntries');
                    
                    if (savedCodes) {
                        const codes = JSON.parse(savedCodes);
                        setProjectCodes(codes);
                        if (codes.length === 0) {
                            setShowSetup(true);
                        }
                    } else {
                        setShowSetup(true);
                    }
                    
                    if (savedEntries) {
                        setTimeEntries(JSON.parse(savedEntries));
                    }
                } catch (error) {
                    console.log('Storage not available, using session data');
                    setStorageError('Local storage unavailable - data will not persist');
                    setShowSetup(true);
                }
            }, []);

            // Save data to localStorage
            useEffect(() => {
                try {
                    localStorage.setItem('projectCodes', JSON.stringify(projectCodes));
                } catch (error) {
                    setStorageError('Failed to save project codes - data may not persist');
                }
            }, [projectCodes]);

            useEffect(() => {
                try {
                    localStorage.setItem('timeEntries', JSON.stringify(timeEntries));
                } catch (error) {
                    setStorageError('Failed to save time entries - data may not persist');
                }
            }, [timeEntries]);

            // Timer effect
            useEffect(() => {
                if (isTracking && currentSession) {
                    intervalRef.current = setInterval(() => {
                        setElapsedTime(Date.now() - currentSession.startTime);
                    }, 1000);
                } else {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                    }
                }

                return () => {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                    }
                };
            }, [isTracking, currentSession]);

            const formatTime = (milliseconds) => {
                const seconds = Math.floor(milliseconds / 1000);
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const remainingSeconds = seconds % 60;
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            };

            const addProjectCode = () => {
                if (!newProjectCode.trim() || !newProjectDescription.trim()) {
                    setStorageError('Please enter both project code and description');
                    return;
                }

                const newProject = {
                    id: Date.now() + Math.random(),
                    code: newProjectCode.trim().toUpperCase(),
                    description: newProjectDescription.trim()
                };

                setProjectCodes(prev => [...prev, newProject]);
                setNewProjectCode('');
                setNewProjectDescription('');
                setStorageError(null);
            };

            const deleteProjectCode = (id) => {
                setProjectCodes(prev => prev.filter(project => project.id !== id));
            };

            const startTracking = () => {
                if (!selectedProject) {
                    setStorageError('Please select a project code');
                    return;
                }

                const project = projectCodes.find(p => p.id.toString() === selectedProject.toString());
                if (!project) return;

                const session = {
                    projectId: project.id,
                    projectCode: project.code,
                    projectDescription: project.description,
                    startTime: Date.now(),
                    date: new Date().toISOString().split('T')[0]
                };

                setCurrentSession(session);
                setIsTracking(true);
                setElapsedTime(0);
                setStorageError(null);
            };

            // Expose timer toggle to global scope for tray integration
            useEffect(() => {
                window.currentTimerToggle = () => {
                    if (isTracking) {
                        stopTracking();
                    } else if (selectedProject) {
                        startTracking();
                    }
                };
            }, [isTracking, selectedProject]);

            const stopTracking = () => {
                if (currentSession) {
                    const endTime = Date.now();
                    const duration = endTime - currentSession.startTime;
                    
                    const newEntry = {
                        id: Date.now() + Math.random(),
                        projectId: currentSession.projectId,
                        projectCode: currentSession.projectCode,
                        projectDescription: currentSession.projectDescription,
                        date: currentSession.date,
                        startTime: new Date(currentSession.startTime).toLocaleTimeString(),
                        endTime: new Date(endTime).toLocaleTimeString(),
                        duration: duration,
                        hours: duration / (1000 * 60 * 60)
                    };

                    setTimeEntries(prev => [...prev, newEntry]);
                    setIsTracking(false);
                    setCurrentSession(null);
                    setElapsedTime(0);
                }
            };

            const switchProject = (newProjectId) => {
                setSelectedProject(newProjectId.toString());

                if (isTracking) {
                    stopTracking();

                    // Start tracking the new project immediately after stopping
                    const project = projectCodes.find(p => p.id === newProjectId);
                    if (project) {
                        const session = {
                            projectId: project.id,
                            projectCode: project.code,
                            projectDescription: project.description,
                            startTime: Date.now(),
                            date: new Date().toISOString().split('T')[0]
                        };

                        setCurrentSession(session);
                        setIsTracking(true);
                        setElapsedTime(0);
                    }
                }
            };

            const deleteEntry = (id) => {
                setTimeEntries(prev => prev.filter(entry => entry.id !== id));
            };

            const getMonthlyEntries = () => {
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                return timeEntries.filter(entry => {
                    const entryDate = new Date(entry.date);
                    return entryDate.getMonth() === currentMonth && entryDate.getFullYear() === currentYear;
                });
            };

            const generateMonthlyTimesheet = () => {
                const monthlyEntries = getMonthlyEntries();
                const projectSummary = {};

                monthlyEntries.forEach(entry => {
                    if (!projectSummary[entry.projectCode]) {
                        projectSummary[entry.projectCode] = {
                            code: entry.projectCode,
                            description: entry.projectDescription,
                            totalHours: 0,
                            entries: []
                        };
                    }
                    projectSummary[entry.projectCode].totalHours += entry.hours;
                    projectSummary[entry.projectCode].entries.push(entry);
                });

                return projectSummary;
            };

            const exportToExcel = () => {
                const monthlyData = generateMonthlyTimesheet();
                const monthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"];
                const currentMonth = monthNames[new Date().getMonth()];
                const currentYear = new Date().getFullYear();

                const summaryHeaders = ['Project Code', 'Description', 'Total Hours'];
                const summaryRows = Object.values(monthlyData).map(project => [
                    project.code,
                    project.description,
                    project.totalHours.toFixed(2)
                ]);

                const detailHeaders = ['Date', 'Project Code', 'Description', 'Start Time', 'End Time', 'Hours'];
                const detailRows = getMonthlyEntries()
                    .map(entry => [
                        entry.date,
                        entry.projectCode,
                        entry.projectDescription,
                        entry.startTime,
                        entry.endTime,
                        entry.hours.toFixed(2)
                    ]);

                const csvContent = [
                    `Monthly Timesheet - ${currentMonth} ${currentYear}`,
                    '',
                    'PROJECT SUMMARY',
                    summaryHeaders.join(','),
                    ...summaryRows.map(row => row.join(',')),
                    '',
                    'DETAILED ENTRIES',
                    detailHeaders.join(','),
                    ...detailRows.map(row => row.join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `timesheet-${currentMonth.toLowerCase()}-${currentYear}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            };

            const exportToQBO = () => {
                const monthlyData = generateMonthlyTimesheet();

                const qboHeaders = ['Date', 'Service Item', 'Description', 'Qty', 'Rate', 'Customer:Job'];
                const qboRows = [];

                Object.values(monthlyData).forEach(project => {
                    project.entries.forEach(entry => {
                        qboRows.push([
                            entry.date,
                            'Consulting Services',
                            `${project.code} - ${project.description}`,
                            entry.hours.toFixed(2),
                            '',
                            project.code
                        ]);
                    });
                });

                const csvContent = [
                    qboHeaders.join(','),
                    ...qboRows.map(row => row.join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `qbo-timesheet-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            };

            const getTotalMonthlyHours = () => {
                const monthlyData = generateMonthlyTimesheet();
                return Object.values(monthlyData).reduce((total, project) => total + project.totalHours, 0);
            };

            const addDemoData = () => {
                const demoProjects = [
                    { id: 1, code: 'ACME-001', description: 'Strategic Planning' },
                    { id: 2, code: 'TECH-DEV', description: 'Software Development' },
                    { id: 3, code: 'CONSULT-A', description: 'Business Analysis' }
                ];
                setProjectCodes(demoProjects);
                setShowSetup(false);
            };

            if (showSetup) {
                return React.createElement('div', { className: "max-w-4xl mx-auto p-6 bg-white min-h-screen" },
                    storageError && React.createElement('div', { className: "mb-4 p-3 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded" },
                        storageError,
                        React.createElement('button', {
                            onClick: () => setStorageError(null),
                            className: "ml-2 text-yellow-800 hover:text-yellow-900"
                        }, "×")
                    ),
                    React.createElement('div', { className: "text-center mb-8" },
                        React.createElement('h1', { className: "text-3xl font-bold text-gray-900 mb-2" }, "Setup Your Project Codes"),
                        React.createElement('p', { className: "text-gray-600" }, "Add all your project codes and tasks upfront for consistent time tracking")
                    ),
                    React.createElement('div', { className: "bg-blue-50 rounded-lg p-6 mb-6" },
                        React.createElement('h2', { className: "text-xl font-semibold mb-4" }, "Add New Project Code"),
                        React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4 mb-4" },
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Project Code"),
                                React.createElement('input', {
                                    type: "text",
                                    value: newProjectCode,
                                    onChange: (e) => setNewProjectCode(e.target.value.toUpperCase()),
                                    placeholder: "e.g., ACME-001, CONSULT-ABC",
                                    className: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                })
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Description"),
                                React.createElement('input', {
                                    type: "text",
                                    value: newProjectDescription,
                                    onChange: (e) => setNewProjectDescription(e.target.value),
                                    placeholder: "e.g., Strategic Planning, Software Development",
                                    className: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                })
                            )
                        ),
                        React.createElement('div', { className: "flex gap-3" },
                            React.createElement('button', {
                                onClick: addProjectCode,
                                className: "flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                            },
                                React.createElement(Plus),
                                "Add Project Code"
                            ),
                            React.createElement('button', {
                                onClick: addDemoData,
                                className: "px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700"
                            }, "Add Demo Data")
                        )
                    ),
                    projectCodes.length > 0 && React.createElement('div', { className: "mb-6" },
                        React.createElement('h3', { className: "text-lg font-semibold mb-3" }, "Your Project Codes"),
                        React.createElement('div', { className: "space-y-2" },
                            projectCodes.map((project) =>
                                React.createElement('div', { key: project.id, className: "flex items-center justify-between p-3 bg-gray-50 rounded-md" },
                                    React.createElement('div', null,
                                        React.createElement('span', { className: "font-semibold text-blue-600" }, project.code),
                                        React.createElement('span', { className: "text-gray-600 ml-3" }, project.description)
                                    ),
                                    React.createElement('button', {
                                        onClick: () => deleteProjectCode(project.id),
                                        className: "text-red-600 hover:text-red-800"
                                    }, React.createElement(Trash2))
                                )
                            )
                        )
                    ),
                    projectCodes.length > 0 && React.createElement('div', { className: "text-center" },
                        React.createElement('button', {
                            onClick: () => setShowSetup(false),
                            className: "px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 text-lg font-semibold"
                        }, "Start Time Tracking")
                    )
                );
            }

            return React.createElement('div', { className: "max-w-6xl mx-auto p-6 bg-white min-h-screen" },
                storageError && React.createElement('div', { className: "mb-4 p-3 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded" },
                    storageError,
                    React.createElement('button', {
                        onClick: () => setStorageError(null),
                        className: "ml-2 text-yellow-800 hover:text-yellow-900"
                    }, "×")
                ),
                React.createElement('div', { className: "flex justify-between items-center mb-8" },
                    React.createElement('div', null,
                        React.createElement('h1', { className: "text-3xl font-bold text-gray-900 mb-2 flex items-center gap-2" },
                            React.createElement(Clock),
                            "Time Tracker"
                        ),
                        React.createElement('p', { className: "text-gray-600" }, "Select project and track time consistently")
                    ),
                    React.createElement('button', {
                        onClick: () => setShowSetup(true),
                        className: "flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
                    },
                        React.createElement(Settings),
                        "Manage Projects"
                    )
                ),
                React.createElement('div', { className: "bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 mb-6 border border-blue-200" },
                    React.createElement('h2', { className: "text-lg font-semibold mb-4" }, "Quick Project Switch"),
                    React.createElement('div', { className: "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3" },
                        projectCodes.map((project) =>
                            React.createElement('button', {
                                key: project.id,
                                onClick: () => switchProject(project.id),
                                className: `p-3 rounded-lg border-2 transition-all text-left ${
                                    selectedProject === project.id.toString()
                                        ? 'border-blue-500 bg-blue-100'
                                        : 'border-gray-200 bg-white hover:border-blue-300'
                                } ${isTracking && currentSession?.projectId === project.id ? 'ring-2 ring-green-400' : ''}`
                            },
                                React.createElement('div', { className: "font-semibold text-blue-600" }, project.code),
                                React.createElement('div', { className: "text-sm text-gray-600 truncate" }, project.description),
                                isTracking && currentSession?.projectId === project.id &&
                                React.createElement('div', { className: "text-xs text-green-600 font-semibold mt-1" }, "● TRACKING")
                            )
                        )
                    )
                ),
                React.createElement('div', { className: "bg-white rounded-lg p-6 mb-6 border border-gray-200 shadow-sm" },
                    React.createElement('div', { className: "flex items-center justify-between" },
                        React.createElement('div', null,
                            currentSession && React.createElement('div', { className: "mb-2" },
                                React.createElement('span', { className: "text-sm text-gray-600" }, "Currently tracking:"),
                                React.createElement('div', { className: "font-semibold text-lg" },
                                    React.createElement('span', { className: "text-blue-600" }, currentSession.projectCode),
                                    React.createElement('span', { className: "text-gray-600 ml-2" }, currentSession.projectDescription)
                                )
                            ),
                            React.createElement('div', { className: "text-4xl font-mono font-bold text-gray-900" }, formatTime(elapsedTime))
                        ),
                        React.createElement('div', { className: "flex gap-3" },
                            !isTracking ?
                                React.createElement('button', {
                                    onClick: startTracking,
                                    disabled: !selectedProject,
                                    className: "flex items-center gap-2 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                                },
                                    React.createElement(Play),
                                    "Start"
                                ) :
                                React.createElement('button', {
                                    onClick: stopTracking,
                                    className: "flex items-center gap-2 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                                },
                                    React.createElement(Square),
                                    "Stop"
                                )
                        )
                    )
                ),
                React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" },
                    React.createElement('div', { className: "bg-white p-4 rounded-lg border border-gray-200 shadow-sm" },
                        React.createElement('div', { className: "flex items-center gap-2 mb-2" },
                            React.createElement(Calendar),
                            React.createElement('h3', { className: "font-semibold text-gray-700" }, "This Month")
                        ),
                        React.createElement('p', { className: "text-2xl font-bold text-gray-900" }, getTotalMonthlyHours().toFixed(1) + "h")
                    ),
                    React.createElement('div', { className: "bg-white p-4 rounded-lg border border-gray-200 shadow-sm" },
                        React.createElement('div', { className: "flex items-center gap-2 mb-2" },
                            React.createElement(BarChart3),
                            React.createElement('h3', { className: "font-semibold text-gray-700" }, "Projects")
                        ),
                        React.createElement('p', { className: "text-2xl font-bold text-gray-900" }, Object.keys(generateMonthlyTimesheet()).length)
                    ),
                    React.createElement('div', { className: "md:col-span-2 flex gap-2" },
                        React.createElement('button', {
                            onClick: exportToExcel,
                            className: "flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",
                            disabled: timeEntries.length === 0
                        },
                            React.createElement(Download),
                            "Export Monthly Timesheet"
                        ),
                        React.createElement('button', {
                            onClick: exportToQBO,
                            className: "flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors",
                            disabled: timeEntries.length === 0
                        },
                            React.createElement(Download),
                            "Export for QBO"
                        )
                    )
                ),
                Object.keys(generateMonthlyTimesheet()).length > 0 && React.createElement('div', { className: "mb-6" },
                    React.createElement('h2', { className: "text-xl font-semibold text-gray-900 mb-3" }, "Monthly Project Summary"),
                    React.createElement('div', { className: "bg-gray-50 rounded-lg p-4" },
                        React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" },
                            Object.values(generateMonthlyTimesheet()).map((project) =>
                                React.createElement('div', { key: project.code, className: "bg-white p-4 rounded border" },
                                    React.createElement('div', { className: "font-semibold text-blue-600" }, project.code),
                                    React.createElement('div', { className: "text-sm text-gray-600 mb-2" }, project.description),
                                    React.createElement('div', { className: "text-xl font-bold text-gray-900" }, project.totalHours.toFixed(2) + "h"),
                                    React.createElement('div', { className: "text-sm text-gray-500" }, project.entries.length + " entries")
                                )
                            )
                        )
                    )
                ),
                React.createElement('div', null,
                    React.createElement('h2', { className: "text-xl font-semibold text-gray-900 mb-3" }, "Recent Time Entries"),
                    timeEntries.length === 0 ?
                        React.createElement('div', { className: "text-center py-8 text-gray-500" },
                            React.createElement(Clock),
                            React.createElement('p', null, "No time entries yet. Select a project and start tracking!")
                        ) :
                        React.createElement('div', { className: "overflow-x-auto" },
                            React.createElement('table', { className: "w-full border border-gray-200 rounded-lg overflow-hidden" },
                                React.createElement('thead', { className: "bg-gray-50" },
                                    React.createElement('tr', null,
                                        React.createElement('th', { className: "px-4 py-3 text-left text-sm font-semibold text-gray-700" }, "Date"),
                                        React.createElement('th', { className: "px-4 py-3 text-left text-sm font-semibold text-gray-700" }, "Project"),
                                        React.createElement('th', { className: "px-4 py-3 text-left text-sm font-semibold text-gray-700" }, "Description"),
                                        React.createElement('th', { className: "px-4 py-3 text-left text-sm font-semibold text-gray-700" }, "Duration"),
                                        React.createElement('th', { className: "px-4 py-3 text-left text-sm font-semibold text-gray-700" }, "Hours"),
                                        React.createElement('th', { className: "px-4 py-3 text-left text-sm font-semibold text-gray-700" }, "Actions")
                                    )
                                ),
                                React.createElement('tbody', { className: "bg-white" },
                                    timeEntries.slice().reverse().slice(0, 10).map((entry) =>
                                        React.createElement('tr', { key: entry.id, className: "border-t border-gray-200 hover:bg-gray-50" },
                                            React.createElement('td', { className: "px-4 py-3 text-gray-700" }, entry.date),
                                            React.createElement('td', { className: "px-4 py-3 font-semibold text-blue-600" }, entry.projectCode),
                                            React.createElement('td', { className: "px-4 py-3 text-gray-700" }, entry.projectDescription),
                                            React.createElement('td', { className: "px-4 py-3 text-gray-700" }, formatTime(entry.duration)),
                                            React.createElement('td', { className: "px-4 py-3 font-semibold text-gray-900" }, entry.hours.toFixed(2)),
                                            React.createElement('td', { className: "px-4 py-3" },
                                                React.createElement('button', {
                                                    onClick: () => deleteEntry(entry.id),
                                                    className: "text-red-600 hover:text-red-800 text-sm font-medium"
                                                }, "Delete")
                                            )
                                        )
                                    )
                                )
                            )
                        )
                )
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(TimeTracker));
    </script>
</body>
</html>